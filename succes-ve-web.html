<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Félicitations - Vitrine Express</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css"> 
</head>
<body class="bg-slate-100 min-h-screen flex flex-col">
<header class="header-main">
    <div class="header-container px-4 sm:px-6"> <a href="index.html" class="logo-group group">
            <img src="images/logo/logo-am20.webp" alt="Logo AM 2.0" class="logo-img w-8 h-8 sm:w-10 sm:h-10"> <div class="logo-text-wrapper">
                <span class="font-bold text-gradient leading-none text-sm sm:text-base">Vitrine Express</span>
                <span class="logo-subtitle tracking-wider uppercase text-[8px] sm:text-[10px]">by AM 2.0</span>
            </div>
        </a>
        <button class="btn-export group px-3 py-1.5 sm:px-4 sm:py-2">
            <span class="font-bold uppercase tracking-tight text-[10px] sm:text-xs text-white">Besoin d'aide ? </span>
            <svg class="w-3 h-3 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
            </svg>
        </button>
    </div>
</header>
<main class="flex-1 flex items-center justify-center p-4 sm:p-6 relative overflow-hidden bg-gradient-accent">
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[300px] h-[300px] sm:w-[500px] sm:h-[500px] bg-violet-200/30 rounded-full blur-[80px] sm:blur-[120px] -z-10"></div>
    <div id="success-card" class="bg-white border border-slate-200 rounded-2xl sm:rounded-3xl shadow-2xl p-6 sm:p-10 max-w-lg w-full text-center transition-all duration-700 transform scale-95 opacity-0">
        <div class="w-16 h-16 sm:w-24 sm:h-24 mx-auto mb-6 sm:mb-8 bg-green-100 rounded-full flex items-center justify-center animate-bounce shadow-sm border border-green-200">
            <svg class="w-8 h-8 sm:w-12 sm:h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
            </svg>
        </div>
        <h1 class="text-2xl sm:text-3xl font-black uppercase tracking-tight text-gradient mb-3 sm:mb-4">Paiement Validé !</h1>
        <p class="text-slate-500 mb-8 sm:mb-10 text-xs sm:text-sm leading-relaxed px-2">
            Félicitations ! Ta page web personnalisée est prête. Il ne reste plus qu'une étape pour propulser ta vitrine en ligne.
        </p>
        <button onclick="startDeployment()" id="deploy-btn" class="w-full bg-gradient-to-r from-[#8449d9] to-[#22c55e] text-white font-black py-4 sm:py-5 rounded-xl sm:rounded-2xl shadow-xl hover:shadow-2xl hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-3 sm:gap-4 group">
            <span class="uppercase tracking-widest text-xs sm:text-sm">Mettre ma vitrine en ligne</span>
            <svg class="w-4 h-4 sm:w-5 sm:h-5 fill-white group-hover:rotate-12 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                <path d="M415.9 344L225 344C227.9 408.5 242.2 467.9 262.5 511.4C273.9 535.9 286.2 553.2 297.6 563.8C308.8 574.3 316.5 576 320.5 576C324.5 576 332.2 574.3 343.4 563.8C354.8 553.2 367.1 535.8 378.5 511.4C398.8 467.9 413.1 408.5 416 344zM224.9 296L415.8 296C413 231.5 398.7 172.1 378.4 128.6C367 104.2 354.7 86.8 343.3 76.2C332.1 65.7 324.4 64 320.4 64C316.4 64 308.7 65.7 297.5 76.2C286.1 86.8 273.8 104.2 262.4 128.6C242.1 172.1 227.8 231.5 224.9 296zM176.9 296C180.4 210.4 202.5 130.9 234.8 78.7C142.7 111.3 74.9 195.2 65.5 296L176.9 296zM65.5 344C74.9 444.8 142.7 528.7 234.8 561.3C202.5 509.1 180.4 429.6 176.9 344L65.5 344zM463.9 344C460.4 429.6 438.3 509.1 406 561.3C498.1 528.6 565.9 444.8 575.3 344L463.9 344zM575.3 296C565.9 195.2 498.1 111.3 406 78.7C438.3 130.9 460.4 210.4 463.9 296L575.3 296z"/>
            </svg>
        </button>
        <p class="mt-6 text-[9px] sm:text-[10px] text-slate-400 uppercase tracking-widest font-bold">
            Déploiement ultra-rapide via Netlify
        </p>
    </div>
</main>
<script>
    window.onload = () => {
        const card = document.getElementById('success-card');
        card.classList.remove('scale-95', 'opacity-0');
        card.classList.add('scale-100', 'opacity-100');
    };
    async function startDeployment() {
        const btn = document.getElementById('deploy-btn');
        const originalContent = btn.innerHTML;
    // 1. Animation de chargement
        btn.innerHTML = `
            <svg class="animate-spin h-5 w-5 text-white" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="uppercase tracking-widest text-xs sm:text-sm font-black">Génération de la vitrine...</span>
        `;
        btn.classList.add('pointer-events-none', 'opacity-80');

        try {
        // 2. Récupération des données sauvegardées
            const savedData = localStorage.getItem('vitrine_express_progression');
            if (!savedData) throw new Error("Aucune configuration trouvée.");
            const config = JSON.parse(savedData);
        // --- CORRECTIF ANTI-VALEUR PAR DÉFAUT ---
            // Si l'utilisateur a oublié de changer "[RAISON SOCIALE]"
            if (config.legal.companyName.includes("[") || config.legal.companyName.trim() === "") {
                config.legal.companyName = "Ma Vitrine " + Math.floor(Math.random() * 999);
            }
        // 3. Construction du HTML final (on injecte les données dans le template)
            const finalHTML = await buildClientSite(config);
            console.log(typeof finalHTML);
        // 4. Envoi vers la fonction Netlify (le "cerveau" serveur)
            const response = await fetch('/.netlify/functions/deploy-client-site', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    html: finalHTML,
                    config: config,
                    siteName: `vitrine-${Date.now()}` // Nom technique unique
                })
            });
            if (!response.ok) throw new Error("Erreur lors de l'envoi vers Netlify");
            const result = await response.json();
        // 5. Succès ! Redirection vers le site en ligne
            btn.innerHTML = "✨ VITRINE EN LIGNE !";
            btn.style.background = "linear-gradient(to right, #22c55e, #16a34a)";
            setTimeout(() => {
                window.location.href = result.deployUrl; 
            }, 1500);
        } catch (error) {
            console.error(error);
            alert("Erreur : " + error.message);
            btn.innerHTML = originalContent;
            btn.classList.remove('pointer-events-none', 'opacity-80');
        }
    }
// FONCTION BUILD : Elle construit le fichier que le client va posséder
   async function buildClientSite(config) {
    try {
        const templateId = config.meta?.template || 'moderne';
        const response = await fetch(`template-${templateId}.html`);
        if (!response.ok) throw new Error("Template introuvable");
        let html = await response.text();
        const companyName = config.header?.companyName || "Ma Vitrine";
    // --- 1. INJECTION SEO ---
        // On cible la balise title peu importe ce qu'il y a dedans
        html = html.replace(/<title>.*?<\/title>/, `<title>${config.hero.title} | ${companyName}</title>`);
        html = html.replace(/id="meta-desc" content=".*?"/, `id="meta-desc" content="${config.hero.desc}"`);
    // --- 2. INJECTION DES TEXTES (Anti-Flash vide) ---
        // On utilise des Regex pour ignorer les espaces ou contenus existants
        html = html.replace(/id="hero-title">.*?<\/h1>/, `id="hero-title">${config.hero.title}</h1>`);
        html = html.replace(/id="hero-desc">.*?<\/p>/, `id="hero-desc">${config.hero.desc}</p>`);
        html = html.replace(/id="hero-cta-btn".*?>.*?<\/a>/, `id="hero-cta-btn" class="cta-button">${config.hero.ctaLabel}</a>`);
        html = html.replace(/id="header-cta".*?>.*?<\/a>/, `id="header-cta" class="cta-button">${config.contact.ctaLabel || 'Contact'}</a>`);
    // SERVICES
        html = html.replace(/id="services-title">.*?<\/h2>/, `id="services-title">${config.services.title}</h2>`);
    // GALLERY / SOCIAL PROOF
        html = html.replace(/id="gallery-title">.*?<\/h2>/, `id="gallery-title">${config.gallery.title}</h2>`);
    // ABOUT
        html = html.replace(/id="about-title">.*?<\/h2>/, `id="about-title">${config.about.title}</h2>`);
        html = html.replace(/id="about-desc">.*?<\/p>/, `id="about-desc">${config.about.desc}</p>`);
    // CONTACT
        html = html.replace(/id="contact-title">.*?<\/h2>/, `id="contact-title">${config.contact.title}</h2>`);
        html = html.replace(/id="contact-desc">.*?<\/p>/, `id="contact-desc">${config.contact.desc}</p>`);
        html = html.replace(/id="contact-cta-btn".*?>.*?<\/a>/, `id="contact-cta-btn" class="cta-button">${config.contact.ctaLabel}</a>`);
    // --- 3. INJECTION DU BLOC JSON ---
        html = html.replace('/*CONFIG_EXPORT*/', JSON.stringify(config));
    // --- 4. LE NETTOYAGE CRUCIAL ---
        // A. On supprime l'appel au fichier config.js
        html = html.replace(/<script src="config\.js"><\/script>/g, '');
    // B. FIX CRUCIAL : On remplace "const CONFIG = localConfig;" par les données réelles
        // pour que renderTemplate() ne plante pas sur le site final.
        const configInjection = `const CONFIG = JSON.parse(document.getElementById('export-data').textContent);`;
        html = html.replace(/const CONFIG = localConfig;/, configInjection);
    // --- 5. COULEURS ---
        const rootColors = `
    <style>
        :root {
            --color-accent: ${config.colors.accent} !important;
            --color-dark: ${config.colors.dark} !important;
            --color-background-light: ${config.colors.bgLight} !important;
        }
    </style>`;
        html = html.replace('</head>', `${rootColors}</head>`);

        return html;
    } catch (error) {
        console.error("Erreur génération :", error);
        throw error;
    }
}
</script>
</body>
</html>